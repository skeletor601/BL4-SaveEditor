<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BL4 Master Search</title>
<style>
/* Default (Ion); overridden by body[data-theme="..."] when app passes ?theme= */
:root {
  --bg: #0f1216;
  --bg-panel: rgba(22, 25, 30, 0.92);
  --border: rgba(60, 68, 78, 0.5);
  --text: #e8eaed;
  --muted: rgba(232, 234, 237, 0.65);
  --accent: #00BFFF;
  --accent-dim: rgba(0, 191, 255, 0.35);
  --legendary: #ff8a00;
}
body[data-theme="Lava"] { --accent: #FF6600; --accent-dim: rgba(255, 102, 0, 0.35); }
body[data-theme="Phoenix"] { --accent: #FF4500; --accent-dim: rgba(255, 69, 0, 0.35); }
body[data-theme="Violet"] { --accent: #BF00FF; --accent-dim: rgba(191, 0, 255, 0.3); }
body[data-theme="Blue_Balls"] { --accent: #0080FF; --accent-dim: rgba(0, 128, 255, 0.35); }
body[data-theme="Artic_Hex"] { --accent: #00FFFF; --accent-dim: rgba(0, 255, 255, 0.35); }
body[data-theme="Carbon_Flux"] { --accent: #00D4AA; --accent-dim: rgba(0, 212, 170, 0.3); }
body[data-theme="Platinum"] { --accent: #A0B8D0; --accent-dim: rgba(160, 184, 208, 0.4); }
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Segoe UI", system-ui, sans-serif;
  font-size: 10.5pt;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

.app-header {
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}
.app-header h1 {
  margin: 0;
  font-size: 16pt;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.badge {
  background: var(--accent-dim);
  color: var(--accent);
  padding: 4px 10px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 12px;
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  padding: 14px 20px;
  background: rgba(18, 21, 26, 0.6);
  border-bottom: 1px solid var(--border);
  align-items: center;
}
.filters label { color: var(--muted); font-size: 11px; margin-right: 4px; }
.filters input[type="text"],
.filters select {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(24, 28, 34, 0.9);
  color: var(--text);
  font-size: 11px;
  min-width: 120px;
}
.filters input[type="text"]:focus,
.filters select:focus {
  outline: none;
  border-color: var(--accent);
}
.filters input[type="text"] { min-width: 200px; }
.fav-check {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
}
.fav-check input { width: 18px; height: 18px; cursor: pointer; }

.fav-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-left: auto;
}
.fav-actions button {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(24, 28, 34, 0.9);
  color: var(--text);
  font-size: 11px;
  cursor: pointer;
}
.fav-actions button:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.fav-hint {
  font-size: 10px;
  color: var(--muted);
  margin-left: 4px;
  align-self: center;
  max-width: 320px;
}

.table-wrap {
  overflow: auto;
  padding: 16px 20px;
  max-height: calc(100vh - 180px);
}
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}
thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: rgba(22, 25, 30, 0.98);
  text-align: left;
  padding: 12px 14px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.4px;
  border-bottom: 1px solid var(--border);
  color: var(--accent);
}
tbody td {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(60, 68, 78, 0.3);
  font-size: 12px;
}
tbody tr:hover { background: var(--accent-dim); }
tbody tr.legendary-row td { color: var(--legendary) !important; font-weight: 600; }
.fav-col { width: 40px; text-align: center; cursor: pointer; user-select: none; }
.fav-col:hover { color: var(--accent); }
.code-cell { font-family: ui-monospace, "Cascadia Code", Consolas, monospace; font-size: 11px; cursor: pointer; }
.code-cell:hover { text-decoration: underline; color: var(--accent); }

#toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 10px 18px;
  border-radius: 12px;
  background: rgba(0,0,0,0.85);
  border: 1px solid var(--accent-dim);
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 9999;
}

.copy-qty-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.copy-qty-dialog {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  min-width: 280px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.copy-qty-dialog h3 { margin: 0 0 14px 0; font-size: 14px; color: var(--text); }
.copy-qty-dialog label { display: block; color: var(--muted); font-size: 11px; margin-bottom: 6px; }
.copy-qty-dialog input[type="number"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(24, 28, 34, 0.9);
  color: var(--text);
  font-size: 14px;
  margin-bottom: 16px;
}
.copy-qty-dialog input[type="number"]:focus { outline: none; border-color: var(--accent); }
.copy-qty-dialog .code-preview { font-family: ui-monospace, Consolas, monospace; font-size: 11px; color: var(--muted); margin-bottom: 14px; word-break: break-all; }
.copy-qty-dialog .buttons { display: flex; gap: 10px; justify-content: flex-end; }
.copy-qty-dialog button {
  padding: 8px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(28, 32, 38, 0.92);
  color: var(--text);
  font-size: 12px;
  cursor: pointer;
}
.copy-qty-dialog button:hover { border-color: var(--accent); }
.copy-qty-dialog button.primary { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>
<script>
(function(){
  var params = new URLSearchParams(window.location.search || '');
  var theme = params.get('theme') || 'Ion';
  if (document.body) document.body.setAttribute('data-theme', theme);
})();
</script>
<div class="app-header">
  <h1>BL4 Master Search</h1>
  <span class="badge" id="countBadge">0</span>
</div>

<div class="filters">
  <div>
    <label>Search</label>
    <input type="text" id="search" placeholder="Search anything… code (245), name, part, effect…" />
  </div>
  <div>
    <label>Category</label>
    <select id="category">
      <option value="">All</option>
      <option value="Weapon">Weapon</option>
      <option value="Shield">Shield</option>
      <option value="Class Mod">Class Mod</option>
      <option value="Enhancement">Enhancement</option>
      <option value="Grenade">Grenade</option>
      <option value="Repkit">Repkit</option>
      <option value="Heavy">Heavy</option>
    </select>
  </div>
  <div>
    <label>Part type</label>
    <select id="partType">
      <option value="">All</option>
    </select>
  </div>
  <div>
    <label>Sort by rarity</label>
    <select id="sortRarity">
      <option value="">Default</option>
      <option value="legendary">Legendary first</option>
      <option value="epic">Epic first</option>
      <option value="rare">Rare first</option>
      <option value="common">Common first</option>
    </select>
  </div>
  <div>
    <label>Manufacturer</label>
    <select id="manufacturer">
      <option value="">All</option>
    </select>
  </div>
  <label class="fav-check">
    <input type="checkbox" id="favoritesOnly" /> Favorites only
  </label>
  <div class="fav-actions">
    <button type="button" id="exportFavBtn">Export favorites</button>
    <button type="button" id="importFavBtn">Import favorites</button>
    <input type="file" id="favImportInput" accept=".json,.txt" style="display:none" />
    <span class="fav-hint" id="favHint">Export saves to your <strong>Downloads</strong> folder as <strong>bl4-favorites.json</strong>. When importing, open that file from Downloads.</span>
  </div>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th class="fav-col">★</th>
        <th>Code</th>
        <th>Item type</th>
        <th>Rarity</th>
        <th>Part name</th>
        <th>Effect</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="toast"></div>

<div id="copyQtyOverlay" class="copy-qty-overlay" style="display: none;">
  <div class="copy-qty-dialog">
    <h3>Copy code</h3>
    <label for="copyQtyInput">Quantity to copy</label>
    <input type="number" id="copyQtyInput" min="1" max="999" value="1" />
    <div class="code-preview" id="copyQtyPreview"></div>
    <div class="buttons">
      <button type="button" id="copyQtyCancel">Cancel</button>
      <button type="button" class="primary" id="copyQtyCopy">Copy</button>
    </div>
  </div>
</div>

<script>
(function(){
  var DATA = [];
  var FAV_KEY = "bl4_parts_favorites_v2";
  var RARITY_ORDER = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };
  var CODE_SEARCH = { "245":"grenade lingering payload", "246":"utility", "243":"repkit", "273":"heavy", "275":"heavy", "282":"heavy", "289":"heavy" };

  function loadFavorites(){ try{ var r = localStorage.getItem(FAV_KEY); if(!r) return new Set(); return new Set(JSON.parse(r)); }catch(e){ return new Set(); } }
  function saveFavorites(s){ try{ localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(s))); }catch(e){} }
  var FAVORITES = loadFavorites();

  function getRowKey(row){
    var s = (row["String"] || row.String || "").toString().trim();
    if(s) return s;
    var id = (row["ID"] != null ? row["ID"] : row.ID != null ? row.ID : "").toString().trim();
    if(id) return "id:" + id;
    return JSON.stringify(row);
  }
  function isFav(row){ return FAVORITES.has(getRowKey(row)); }
  function toggleFav(row){ var k = getRowKey(row); if(!k) return false; if(FAVORITES.has(k)) FAVORITES.delete(k); else FAVORITES.add(k); saveFavorites(FAVORITES); return FAVORITES.has(k); }

  function blob(row){
    if(row._blob) return row._blob;
    var parts = []; var k; for(k in row){ if(k==="_blob"||k==="__hot") continue; var v = row[k]; if(v!=null&&String(v).trim()) parts.push(String(v)); }
    var pt = (row["Part Type"]||"").toString().trim().toLowerCase();
    if(pt === "rarity") parts.push("skin");
    row._blob = parts.join(" ").toLowerCase();
    return row._blob;
  }
  function inferRarity(row){
    var h = ((row["Model Name"]||"")+" "+(row["Part Type"]||"")+" "+(row["Stats (Level 50, Common)"]||"")+" "+(row["String"]||"")+" "+(row.Stats||"")).toLowerCase();
    if(isLegendaryByName(row)) return "legendary";
    if(h.indexOf("legendary")>=0) return "legendary";
    if(h.indexOf("epic")>=0) return "epic";
    if(h.indexOf("rare")>=0) return "rare";
    if(h.indexOf("uncommon")>=0) return "uncommon";
    if(h.indexOf("common")>=0) return "common";
    return "";
  }
  var LEG_NAMES = ["Aegon's Dream","Bloody Lumberjack","Bonnie and Clyde","Bugbear","Chuck","Cold Shoulder","Divided Focus","First Impression","G.M.R","Goalkeeper","Lucian's Flank","Murmur","Oscar Mike","Potato Thrower IV","Rowan's Charge","Rowdy Rider","Star Helix","Whiskey Foxtrot","Wombo Combo","Budget Deity","Bully","Hardpoint","Inscriber","King's Gambit","Lucky Clover","Noisy Cricket","Phantom Flame","Queen's Rest","Rangefinder","Roach","Ruby's Grasp","San Saba Songbird","Seventh Sense","Sideshow","Zipper","Acey May","Anarchy","Bod","Convergence","Forsaken Chaos","Golden God","Goremaster","Hellwalker","Hot Slugger","Husky Friend","Kaleidosplode","Kickballer","Lead Balloon","Linebacker","Mantra","Missilaser","Rainbow Vomit","Sweet Embrace","T.K's Wave","Aching Roil","Birt's Bees","Darkbeast","Hellfire","Kaoson","Luty Madlad","Matador's Match","Ohm I Got","Onslaught","Plasma Coil","Prince Harming","Asher's Rise","Boomslang","Borstel Ballista","Complex Root","Finnity XXX-L","Fisheye","Katagawa's Revenge","Midnight Defiance","Rainmaker","Rooker","Stop Gap","Stray","Symmetry","Truck","Vamoose","Adrenaline Pump","AF1000","Blood Analyzer","Defibrillator","Healthraiser","Kill Spring","Pacemaker","Triple Bypass","War Paint","Blockbuster","Buoy","Buzz Axe","Chaumurky","Destructo Disco","Faulty Detonator","Firepot","Fuse","Jelly","Recursive","Sho Kunai","Skully","Slippy","Spinning Blade","Swarm","Transmitter","UAV","Urchin","Waterfall","Atling Gun","Bottled Lightning","Disc Jockey","Gamma Void","Inkling","Jetsetter","Ravenfire","Sidewinder","Sprezzatura","Streamer","Blacksmith","Elementalist","Forge Master","Furnace","Lamplighter","Shatterwight","Viking","Driver","Bio-Robot","Generator","Reactor","Scientist","Skeptic","Trooper","Buster","Dancer","Esgrimidor","Filántropo","Grenazerker","Instigator","Overdriver","Avatar","Illusionist","Misericorde","Kindread Spirits","Teen Witch","Technomancer","Undead Eye","Compleation","Firewerks","Heavyweight","Hoarder","Oak-Aged Cask","Onion","Principal","Timekeeper's New Shield","Undershield","Cindershelly","Extra Medium","Guardian Angel","Firebreak","Pandoran Momento","Protean Cell","Sparky Shield","Super Soldier","Watts 4 Dinner"];
  function norm(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"").trim(); }
  var LEG_SET = new Set(LEG_NAMES.map(function(n){ return norm(n); }).filter(Boolean));
  function isLegendaryByName(row){
    var n = norm(row["Model Name"]||row.name||row.title||"");
    if(!n) return false;
    if(LEG_SET.has(n)) return true;
    var it; for(it of LEG_SET){ if(n.indexOf(it)>=0||it.indexOf(n)>=0) return true; }
    return false;
  }
  function exportFavoritesToFile(){
    try{
      var payload = { version: 1, keys: Array.from(FAVORITES) };
      var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "bl4-favorites.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast("Saved to Downloads as bl4-favorites.json");
    }catch(e){
      console.error("Export favorites failed", e);
      toast("Export failed");
    }
  }
  function importFavoritesFromFile(file){
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev){
      try{
        var text = ev.target.result || "";
        var data = JSON.parse(text);
        var keys = [];
        if(Array.isArray(data)) keys = data;
        else if(data && Array.isArray(data.keys)) keys = data.keys;
        var changed = false;
        keys.forEach(function(k){
          if(typeof k === "string" && k){
            if(!FAVORITES.has(k)){
              FAVORITES.add(k);
              changed = true;
            }
          }
        });
        if(changed){
          saveFavorites(FAVORITES);
          render();
          toast("Favorites imported from " + (file.name || "file"));
        }else{
          toast("No new favorites in that file");
        }
      }catch(e){
        console.error("Import favorites failed", e);
        toast("Import failed");
      }
    };
    reader.readAsText(file, "utf-8");
  }
  function deriveCategory(row){
    var wt = (row["Weapon Type"]||"").toString().toLowerCase();
    var pt = (row["Part Type"]||"").toString().toLowerCase();
    var cat = (row.category||"").toString().toLowerCase();
    if(cat.indexOf("class mod")>=0) return "Class Mod";
    if(cat.indexOf("enhancement")>=0||pt.indexOf("enhancement")>=0) return "Enhancement";
    if(cat.indexOf("shield")>=0||pt.indexOf("shield")>=0) return "Shield";
    if(cat.indexOf("grenade")>=0||pt.indexOf("grenade")>=0) return "Grenade";
    if(cat.indexOf("repkit")>=0||pt.indexOf("repkit")>=0) return "Repkit";
    if(wt.indexOf("heavy")>=0||wt.indexOf("launcher")>=0||wt.indexOf("ordnance")>=0||pt.indexOf("heavy")>=0) return "Heavy";
    if(wt.indexOf("assault")>=0||wt.indexOf("rifle")>=0||wt.indexOf("pistol")>=0||wt.indexOf("smg")>=0||wt.indexOf("shotgun")>=0||wt.indexOf("sniper")>=0) return "Weapon";
    if(wt) return "Weapon";
    return "";
  }
  function getCode(row){ return (row.code||row.Code||"").toString().trim() || (row["ID"]!=null ? "{"+row["ID"]+"}" : "—"); }
  function getPartName(row){
    var name = (row["String"]||row["Model Name"]||row.String||"").toString().trim() || "—";
    var pt = (row["Part Type"]||"").toString().trim().toLowerCase();
    if(pt === "rarity") name = name + " Skin";
    return name;
  }
  function getEffect(row){ return (row["Stats (Level 50, Common)"]||row["Effects"]||row.Stats||"").toString().trim() || "—"; }

  /** Parse code like {33:22} or {33} into { prefix, part }. */
  function parseCode(codeStr){
    var s = (codeStr||"").toString().trim();
    var two = s.match(/^\s*\{\s*(\d+)\s*:\s*(\d+)\s*\}\s*$/);
    if(two) return { prefix: parseInt(two[1],10), part: parseInt(two[2],10) };
    var one = s.match(/^\s*\{\s*(\d+)\s*\}\s*$/);
    if(one){ var n = parseInt(one[1],10); return { prefix: n, part: n }; }
    return null;
  }
  /** Build BL modding format: {xx:[yy yy yy ...]} with part repeated qty times. */
  function buildCopyFormat(prefix, part, qty){
    qty = Math.max(1, Math.min(999, parseInt(qty,10)||1));
    var parts = [];
    for(var i=0;i<qty;i++) parts.push(String(part));
    return "{" + prefix + ":[" + parts.join(" ") + "]}";
  }

  function matchSearch(row, q){
    if(!q) return true;
    var h = blob(row);
    if(h.indexOf(q)>=0) return true;
    var t = q.trim();
    if(/^\d+$/.test(t) && CODE_SEARCH[t]){ var words = CODE_SEARCH[t].split(/\s+/); for(var w=0;w<words.length;w++) if(h.indexOf(words[w])>=0) return true; return false; }
    return false;
  }

  async function loadDB(){
    /* Always use most complete DB: try universal first, then community fallback */
    var urls = ["db/universal_parts_db.json", "db/community_parts_db.json"];
    for(var u=0; u<urls.length; u++){
      try{
        var res = await fetch(urls[u], {cache:"no-store"});
        if(!res.ok) throw new Error(res.status);
        var payload = await res.json();
        var rows = payload.rows || [];
        if(!Array.isArray(rows)) rows = [];
        if(rows.length===0) throw new Error("empty");
        DATA = rows;
        for(var i=0;i<DATA.length;i++) if(DATA[i]) delete DATA[i]._blob;
        fillPartTypeSelect();
        fillManufacturerSelect();
        return;
      }catch(e){ if(u===urls.length-1) console.warn("Load DB failed", e); }
    }
    DATA = [];
  }
  function fillPartTypeSelect(){
    var set = {}; DATA.forEach(function(r){ var p = (r["Part Type"]||"").toString().trim(); if(p) set[p]=1; });
    var opts = Object.keys(set).sort();
    var sel = document.getElementById("partType");
    sel.innerHTML = "<option value=\"\">All</option>";
    opts.forEach(function(o){ var opt = document.createElement("option"); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
  }
  function fillManufacturerSelect(){
    var set = {}; DATA.forEach(function(r){ var m = (r["Manufacturer"]||"").toString().trim(); if(m) set[m]=1; });
    var opts = Object.keys(set).sort();
    var sel = document.getElementById("manufacturer");
    sel.innerHTML = "<option value=\"\">All</option>";
    opts.forEach(function(o){ var opt = document.createElement("option"); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
  }

  function render(){
    var q = (document.getElementById("search").value||"").trim().toLowerCase();
    var cat = (document.getElementById("category").value||"").trim();
    var partType = (document.getElementById("partType").value||"").trim();
    var sortR = (document.getElementById("sortRarity").value||"").trim();
    var mfr = (document.getElementById("manufacturer").value||"").trim();
    var favOnly = document.getElementById("favoritesOnly").checked;

    var rows = [];
    for(var i=0;i<DATA.length;i++){
      var r = DATA[i];
      if(!matchSearch(r, q)) continue;
      if(cat && deriveCategory(r) !== cat) continue;
      if(partType && (r["Part Type"]||"").toString().trim() !== partType) continue;
      if(mfr && (r["Manufacturer"]||"").toString().trim() !== mfr) continue;
      if(favOnly && !isFav(r)) continue;
      rows.push(r);
    }
    if(sortR){
      rows.sort(function(a,b){
        var ra = inferRarity(a), rb = inferRarity(b);
        var oa = RARITY_ORDER[ra] != null ? RARITY_ORDER[ra] : 99;
        var ob = RARITY_ORDER[rb] != null ? RARITY_ORDER[rb] : 99;
        if(sortR === "common") return ob - oa;
        return oa - ob;
      });
    }

    var tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    var cap = 10000;
    for(var j=0;j<rows.length && j<cap;j++){
      var row = rows[j];
      var rarity = inferRarity(row);
      var tr = document.createElement("tr");
      if(rarity === "legendary") tr.className = "legendary-row";

      var tdFav = document.createElement("td");
      tdFav.className = "fav-col";
      tdFav.textContent = isFav(row) ? "★" : "☆";
      tdFav.title = isFav(row) ? "Remove favorite" : "Add favorite";
      tdFav.addEventListener("click", function(rr){
        return function(){ toggleFav(rr); this.textContent = isFav(rr) ? "★" : "☆"; this.title = isFav(rr) ? "Remove favorite" : "Add favorite"; if(document.getElementById("favoritesOnly").checked) render(); };
      }(row));
      tr.appendChild(tdFav);

      var tdCode = document.createElement("td");
      tdCode.className = "code-cell";
      tdCode.textContent = getCode(row);
      tdCode.title = "Click to copy (choose quantity)";
      tdCode.addEventListener("click", (function(codeVal){ return function(){ openCopyQtyDialog(codeVal); }; })(getCode(row)));
      tr.appendChild(tdCode);

      var tdType = document.createElement("td");
      tdType.textContent = (row["Part Type"]||"").toString().trim() || "—";
      tr.appendChild(tdType);

      var tdRar = document.createElement("td");
      tdRar.textContent = rarity || "—";
      tr.appendChild(tdRar);

      var tdPart = document.createElement("td");
      tdPart.textContent = getPartName(row);
      tr.appendChild(tdPart);

      var tdEff = document.createElement("td");
      tdEff.textContent = getEffect(row);
      tr.appendChild(tdEff);

      tbody.appendChild(tr);
    }
    document.getElementById("countBadge").textContent = String(rows.length);
  }
  function copyToClipboard(t){
    function fallback(){ try{ var ta = document.createElement("textarea"); ta.value = t; ta.style.position="fixed"; ta.style.left="-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); return true; }catch(e){ return false; } }
    if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(t).then(function(){ toast("Copied"); }, fallback); }
    else if(fallback()) toast("Copied");
    else toast("Copy failed");
  }
  function toast(msg){ var el = document.getElementById("toast"); if(!el) return; el.textContent = msg; el.style.opacity = "1"; setTimeout(function(){ el.style.opacity = "0"; }, 800); }

  var _copyQtyCode = "";
  function openCopyQtyDialog(codeStr){
    var parsed = parseCode(codeStr);
    if(!parsed){ toast("Could not parse code"); return; }
    _copyQtyCode = codeStr;
    var inp = document.getElementById("copyQtyInput");
    var preview = document.getElementById("copyQtyPreview");
    inp.value = "1";
    function updatePreview(){
      var q = parseInt(inp.value,10)||1;
      var qty = Math.max(1, Math.min(999, q));
      inp.value = qty;
      preview.textContent = buildCopyFormat(parsed.prefix, parsed.part, qty);
    }
    updatePreview();
    inp.oninput = updatePreview;
    document.getElementById("copyQtyOverlay").style.display = "flex";
    inp.focus();
  }
  function closeCopyQtyDialog(){
    document.getElementById("copyQtyOverlay").style.display = "none";
  }
  (function(){
    var overlay = document.getElementById("copyQtyOverlay");
    var inp = document.getElementById("copyQtyInput");
    document.getElementById("copyQtyCancel").onclick = closeCopyQtyDialog;
    overlay.onclick = function(e){ if(e.target === overlay) closeCopyQtyDialog(); };
    document.getElementById("copyQtyCopy").onclick = function(){
      var parsed = parseCode(_copyQtyCode);
      if(!parsed) return;
      var qty = Math.max(1, Math.min(999, parseInt(inp.value,10)||1));
      var text = buildCopyFormat(parsed.prefix, parsed.part, qty);
      copyToClipboard(text);
      closeCopyQtyDialog();
    };
  })();

  ["search","category","partType","sortRarity","manufacturer","favoritesOnly"].forEach(function(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  // Wire export/import favorites buttons
  var exportBtn = document.getElementById("exportFavBtn");
  if(exportBtn){
    exportBtn.addEventListener("click", exportFavoritesToFile);
  }
  var importBtn = document.getElementById("importFavBtn");
  var importInput = document.getElementById("favImportInput");
  if(importBtn && importInput){
    importBtn.addEventListener("click", function(){
      importInput.value = "";
      importInput.click();
    });
    importInput.addEventListener("change", function(ev){
      var file = ev.target.files && ev.target.files[0];
      if(file) importFavoritesFromFile(file);
    });
  }

  (async function(){
    await loadDB();
    render();
  })();
})();
</script>
</body>
</html>
